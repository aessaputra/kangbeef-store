name: Kangbeef CI/CD

on:
  push:
    branches: ["main", "dev"]
  pull_request:
    branches: ["main", "dev"]

env:
  PHP_VERSION: "8.3"
  NODE_VERSION: "20"

# Concurrency to prevent multiple runs of the same workflow
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  test:
    runs-on: ubuntu-latest
    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: root
          MYSQL_DATABASE: kangbeef_test
          MYSQL_ALLOW_EMPTY_PASSWORD: no
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping -h localhost"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=10
          --name=mysql_ci
      redis:
        image: redis:6.2-alpine
        ports:
          - 6379:6379
        options: --health-cmd="redis-cli ping" --health-interval=5s --health-timeout=2s --health-retries=12

    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Setup PHP + extensions
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ env.PHP_VERSION }}
          extensions: mbstring, bcmath, ctype, fileinfo, json, tokenizer, xml, pdo, pdo_mysql, openssl, curl, zip, intl, gd
          ini-values: |
            memory_limit=4G
            max_execution_time=360
            date.timezone=Asia/Singapore

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Copy CI env
        run: |
          cp .env.ci .env
          # ensure DB host/port for runner (runner connects to service via localhost)
          php -r "file_put_contents('.env', preg_replace(['/DB_HOST=.*/','/DB_PORT=.*/'], ['DB_HOST=127.0.0.1','DB_PORT=3306'], file_get_contents('.env')));"
          cat .env

      - name: Cache Composer dependencies
        uses: actions/cache@v4
        with:
          path: ~/.composer/cache
          key: ${{ runner.os }}-composer-${{ hashFiles('**/composer.lock') }}
          restore-keys: |
            ${{ runner.os }}-composer-

      - name: Install Composer dependencies
        run: composer install --no-interaction --no-suggest --prefer-dist --optimize-autoloader

      - name: Wait for MySQL to be ready
        run: |
          echo "Waiting for MySQL to be ready (up to ~120s)..."
          for i in $(seq 1 24); do
            if mysqladmin ping -h 127.0.0.1 -uroot -proot --silent; then
              echo "MySQL is up!"
              mysql -h 127.0.0.1 -uroot -proot -e "SHOW DATABASES;"
              mysql -h 127.0.0.1 -uroot -proot -e "USE kangbeef_test; SHOW TABLES;"
              break
            fi
            echo "MySQL not ready yet ($i/24). Sleeping 5s..."
            sleep 5
          done
          
          # Final connection test
          if ! mysql -h 127.0.0.1 -uroot -proot -e "SELECT 1;"; then
            echo "ERROR: MySQL connection failed"
            exit 1
          fi

      - name: Generate APP_KEY (persist to .env)
        run: |
          php artisan key:generate --force
          echo "APP_KEY generated and saved in .env"
          grep APP_KEY .env || true

      - name: Run migrations
        run: php artisan migrate --force

      - name: Run tests
        run: ./vendor/bin/pest --colors=always --coverage-clover=coverage.xml

      - name: Upload coverage reports to Codecov
        if: github.event_name == 'push'
        uses: codecov/codecov-action@v4
        with:
          file: ./coverage.xml
          flags: unittests
          name: codecov-umbrella
  deploy:
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/dev'
    environment:
      name: ${{ github.ref == 'refs/heads/main' && 'production' || 'staging' }}
      url: ${{ steps.deploy.outputs.url }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Setup SSH agent
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.DEPLOY_SSH_KEY }}

      - name: Upload repo tarball to runner
        run: |
          git archive -o release.tar HEAD
          mkdir -p release && tar -xf release.tar -C release

      - name: Copy release to remote and run deploy script
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          port: ${{ secrets.SSH_PORT }}
          source: "release/**"
          target: "${{ secrets.REMOTE_TMP_DIR }}/repo_release"

      - name: Execute remote deploy script
        id: deploy
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          port: ${{ secrets.SSH_PORT }}
          script: |
            set -euo pipefail
            # Ensure target dirs exist
            mkdir -p "${{ secrets.REMOTE_RELEASES_DIR }}" "${{ secrets.REMOTE_SHARED_DIR }}"
            # Move uploaded release into releases folder and invoke server script
            TIMESTAMP=$(date +%Y%m%d%H%M%S)
            mv "${{ secrets.REMOTE_TMP_DIR }}/repo_release" "${{ secrets.REMOTE_RELEASES_DIR }}/$TIMESTAMP"
            # Ensure deploy script exists and is executable
            if [ ! -x "${{ secrets.REMOTE_DEPLOY_SCRIPT }}" ]; then
              echo "ERROR: deploy script not found or not executable at ${{ secrets.REMOTE_DEPLOY_SCRIPT }}"
              exit 1
            fi
            # NOTE: we pass branch name using github.ref_name (expanded by Actions runner)
            sudo -E "${{ secrets.REMOTE_DEPLOY_SCRIPT }}" "$TIMESTAMP" "${{ github.ref_name }}"
            
            # Output deployment URL for environment
            if [ "${{ github.ref_name }}" = "main" ]; then
              echo "url=https://kangbeef.com" >> $GITHUB_OUTPUT
            else
              echo "url=https://staging.kangbeef.com" >> $GITHUB_OUTPUT
            fi
