name: Kangbeef CI/CD

on:
  push:
    branches: ["main", "dev"]
  pull_request:
    branches: ["main", "dev"]

env:
  PHP_VERSION: "8.3"
  NODE_VERSION: "20"

# Concurrency to prevent multiple runs of the same workflow
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  test:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: root
          MYSQL_DATABASE: kangbeef_test
          MYSQL_ALLOW_EMPTY_PASSWORD: no
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping -h 127.0.0.1"
          --health-interval=5s
          --health-timeout=10s
          --health-retries=20
          --name=mysql_ci
      redis:
        image: redis:6.2-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd="redis-cli ping"
          --health-interval=5s
          --health-timeout=2s
          --health-retries=12

    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Setup PHP + extensions
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ env.PHP_VERSION }}
          extensions: mbstring, bcmath, ctype, fileinfo, json, tokenizer, xml, pdo, pdo_mysql, openssl, curl, zip, intl, gd
          ini-values: |
            memory_limit=4G
            max_execution_time=360
            date.timezone=Asia/Jakarta
            pcov.enabled=1
            pcov.directory=./coverage
            pcov.exclude="~(vendor|tests)~"
          coverage: pcov

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Get Composer cache directory
        id: composer-cache
        run: echo "dir=$(composer config cache-files-dir)" >> $GITHUB_OUTPUT

      - name: Cache Composer dependencies
        uses: actions/cache@v4
        with:
          path: ${{ steps.composer-cache.outputs.dir }}
          key: ${{ runner.os }}-composer-${{ hashFiles('**/composer.lock') }}
          restore-keys: |
            ${{ runner.os }}-composer-

      - name: Install Composer dependencies
        run: |
          echo "Installing Composer dependencies..."
          composer install --no-interaction --prefer-dist --optimize-autoloader --no-progress
          echo "âœ… Composer dependencies installed!"

      - name: Cache NPM dependencies
        uses: actions/cache@v4
        with:
          path: ~/.npm
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

      - name: Install NPM dependencies
        run: |
          echo "Installing NPM dependencies..."
          npm ci
          echo "âœ… NPM dependencies installed!"

      - name: Check Shop package.json exists
        run: |
          if [ ! -f "packages/Webkul/Shop/package.json" ]; then
            echo "âŒ Shop package.json not found!"
            exit 1
          fi
          echo "âœ… Shop package.json found!"

      - name: Install NPM dependencies (Shop)
        run: |
          echo "Installing NPM dependencies for Shop..."
          if [ -f packages/Webkul/Shop/package-lock.json ]; then
            echo "ðŸ“¦ Using package-lock.json for Shop"
            npm ci --prefix packages/Webkul/Shop
          else
            echo "âš ï¸ No package-lock.json found for Shop, running npm install"
            npm install --prefix packages/Webkul/Shop
          fi
          echo "âœ… Shop NPM dependencies installed!"
        continue-on-error: true

      - name: Check Admin package.json exists
        run: |
          if [ ! -f "packages/Webkul/Admin/package.json" ]; then
            echo "âŒ Admin package.json not found!"
            exit 1
          fi
          echo "âœ… Admin package.json found!"

      - name: Install NPM dependencies (Admin)
        run: |
          echo "Installing NPM dependencies for Admin..."
          if [ -f packages/Webkul/Admin/package-lock.json ]; then
            echo "ðŸ“¦ Using package-lock.json for Admin"
            npm ci --prefix packages/Webkul/Admin
          else
            echo "âš ï¸ No package-lock.json found for Admin, running npm install"
            npm install --prefix packages/Webkul/Admin
          fi
          echo "âœ… Admin NPM dependencies installed!"
        continue-on-error: true

      - name: Copy CI env
        run: |
          cp .env.ci .env
          php -r "file_put_contents('.env', preg_replace(['/DB_HOST=.*/','/DB_PORT=.*/','/DB_PASSWORD=.*/','/BROADCAST_DRIVER=.*/','/REDIS_CLIENT=.*/','/APP_CURRENCY=.*/'], ['DB_HOST=127.0.0.1','DB_PORT=3306','DB_PASSWORD=root','BROADCAST_DRIVER=log','REDIS_CLIENT=predis','APP_CURRENCY=USD'], file_get_contents('.env')));"

      - name: Wait for MySQL to be ready
        run: |
          echo "Waiting for MySQL to be ready (up to ~120s)..."
          for i in $(seq 1 30); do
            if mysqladmin ping -h 127.0.0.1 -uroot -proot --silent; then
              echo "MySQL is up after $i attempts!"
              mysql -h 127.0.0.1 -uroot -proot -e "SHOW DATABASES;"
              mysql -h 127.0.0.1 -uroot -proot -e "USE kangbeef_test; SHOW TABLES;" || echo "No tables found - expected for fresh database"
              break
            fi
            echo "MySQL not ready yet ($i/30). Sleeping 2s..."
            sleep 2
          done

          # Final connection test with proper error handling
          if ! mysql -h 127.0.0.1 -uroot -proot -e "SELECT 1;" 2>/dev/null; then
            echo "ERROR: MySQL connection failed"
            exit 1
          fi

          echo "âœ… MySQL connection verified successfully!"

      - name: Generate APP_KEY (persist to .env)
        run: |
          php artisan key:generate --force
          echo "APP_KEY generated and saved in .env"

      - name: Setup Database
        run: |
          echo "Setting up database..."

          # Verify database connection first
          php artisan tinker --execute="DB::connection()->getPdo(); echo 'Database connection verified';" || {
            echo "âŒ Database connection failed!"
            exit 1
          }

          # Run migrations with verbose output
          php artisan migrate --force -v || {
            echo "âŒ Database migrations failed!"
            exit 1
          }

          # Verify migrations completed
          echo "âœ… Database migrations completed!"

          # Optional: Seed database if needed
          if [ -f "database/seeders/DatabaseSeeder.php" ]; then
            echo "Seeding database..."
            php artisan db:seed --class=DatabaseSeeder --force || echo "No seeders found or seeding failed"
          fi

      - name: Verify Setup
        run: |
          echo "Verifying test setup..."

          # Check Laravel environment using grep on .env file
          echo "APP_ENV: $(grep APP_ENV .env | cut -d'=' -f2)"
          echo "DB_CONNECTION: $(grep DB_CONNECTION .env | cut -d'=' -f2)"
          echo "DB_DATABASE: $(grep DB_DATABASE .env | cut -d'=' -f2)"

          # Test database connection from Laravel
          php artisan tinker --execute="echo 'Laravel database connection: ' . DB::connection()->getDatabaseName();"

          echo "âœ… Setup verification completed!"

      - name: Run Pint Tests (Code Formatting)
        run: |
          echo "ðŸ” Running Pint code formatting checks..."

          # Run Pint for code formatting
          if ! vendor/bin/pint --test; then
            echo "âŒ Code formatting issues found!"
            echo "Run 'vendor/bin/pint' to fix formatting issues."
            exit 1
          fi

          echo "âœ… Pint code formatting checks passed!"

      - name: Run Pest Tests (Unit/Feature Tests)
        run: |
          echo "ðŸ§ª Running Pest tests..."

          # Run tests with better error handling and verbose output
          php artisan test --coverage || {
            echo "âŒ Pest tests failed!"
            echo "ðŸ“Š Tests failed - no coverage to upload"
            echo "Check logs above for detailed error information"
            exit 1
          }

          echo "âœ… All Pest tests completed!"

      - name: Security Audit
        run: |
          echo "ðŸ”’ Running security audit..."

          # Debug environment variables
          echo "Current COMPOSER_NO_AUDIT value: ${COMPOSER_NO_AUDIT:-not_set}"

          # Force disable audit prevention and continue on warning
          env COMPOSER_NO_AUDIT=0 composer audit --format=table || {
            echo "âš ï¸ Security vulnerabilities found in dependencies!"
            echo "Please review and update vulnerable packages."
            echo "ðŸ“ Continuing workflow despite vulnerabilities..."
          }

          echo "âœ… No security vulnerabilities found!"
        env:
          PHP_VERSION: 8.3
          NODE_VERSION: 20
          COMPOSER_PROCESS_TIMEOUT: 0
          COMPOSER_NO_INTERACTION: 1

      - name: Upload coverage reports to Codecov
        if: success() && github.event_name == 'push'
        uses: codecov/codecov-action@v5
        with:
          token: ${{ secrets.CODECOV_TOKEN }}

      - name: Upload Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-${{ env.PHP_VERSION }}-${{ github.run_number }}
          path: |
            ./storage/logs/
            ./coverage.xml
          retention-days: 30
          if-no-files-found: warn

      - name: Test Summary
        if: always()
        run: |
          echo "## ðŸ§ª Test Summary" >> $GITHUB_STEP_SUMMARY
          echo "| Test Type | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Pint (Code Formatting) | ${{ job.status == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Pest (Unit/Feature) | ${{ job.status == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY

          if [ "${{ job.status }}" = "success" ]; then
            echo "âœ… All tests passed successfully!"
          else
            echo "âŒ Some tests failed. Check the logs above for details."
            exit 1
          fi

  deploy:
    needs: test
    runs-on: ubuntu-latest
    timeout-minutes: 20
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/dev'
    environment:
      name: ${{ github.ref == 'refs/heads/main' && 'production' || 'staging' }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Setup SSH agent
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.DEPLOY_SSH_KEY }}

      - name: Upload repo tarball to runner
        run: |
          git archive -o release.tar HEAD
          mkdir -p release && tar -xf release.tar -C release

      - name: Copy release tarball to remote
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          port: ${{ secrets.SSH_PORT }}
          source: "release.tar"
          target: "${{ secrets.REMOTE_TMP_DIR }}"

      - name: Execute remote deploy script
        id: deploy
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          port: ${{ secrets.SSH_PORT }}
          script: |
            set -euo pipefail
            # Ensure target dirs exist
            mkdir -p "${{ secrets.REMOTE_RELEASES_DIR }}" "${{ secrets.REMOTE_SHARED_DIR }}"
            # Move uploaded release into releases folder and invoke server script
            TIMESTAMP=$(date +%Y%m%d%H%M%S)
            mkdir -p "${{ secrets.REMOTE_RELEASES_DIR }}/$TIMESTAMP"
            tar -xf "${{ secrets.REMOTE_TMP_DIR }}/release.tar" -C "${{ secrets.REMOTE_RELEASES_DIR }}/$TIMESTAMP"
            rm -f "${{ secrets.REMOTE_TMP_DIR }}/release.tar"
            # Ensure deploy script exists and is executable
            if [ ! -x "${{ secrets.REMOTE_DEPLOY_SCRIPT }}" ]; then
              echo "ERROR: deploy script not found or not executable at ${{ secrets.REMOTE_DEPLOY_SCRIPT }}"
              exit 1
            fi
            # NOTE: we pass branch name using github.ref_name (expanded by Actions runner)
            "${{ secrets.REMOTE_DEPLOY_SCRIPT }}" "$TIMESTAMP" "${{ github.ref_name }}"

            # Output deployment URL for environment
            if [ "${{ github.ref_name }}" = "main" ]; then
              echo "url=https://kangbeef.com" >> $GITHUB_OUTPUT
            else
              echo "url=https://staging.kangbeef.com" >> $GITHUB_OUTPUT
            fi
