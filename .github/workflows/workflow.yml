name: Kangbeef CI/CD

on:
  push:
    branches: ["main", "dev"]
  pull_request:
    branches: ["main", "dev"]

env:
  PHP_VERSION: "8.3"
  NODE_VERSION: "20"

# Concurrency to prevent multiple runs of the same workflow
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        php-version: ["8.2", "8.3"]
        include:
          - php-version: "8.2"
            stability: "stable"
          - php-version: "8.3"
            stability: "stable"
      fail-fast: false
    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: root
          MYSQL_DATABASE: kangbeef_test
          MYSQL_ALLOW_EMPTY_PASSWORD: no
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping -h 127.0.0.1"
          --health-interval=5s
          --health-timeout=10s
          --health-retries=20
          --name=mysql_ci
      redis:
        image: redis:6.2-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd="redis-cli ping"
          --health-interval=5s
          --health-timeout=2s
          --health-retries=12

    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Setup PHP + extensions
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ matrix.php-version }}
          extensions: mbstring, bcmath, ctype, fileinfo, json, tokenizer, xml, pdo, pdo_mysql, openssl, curl, zip, intl, gd
          ini-values: |
            memory_limit=4G
            max_execution_time=360
            date.timezone=Asia/Singapore
            pcov.enabled=1
            pcov.directory=./coverage
            pcov.exclude="~vendor~,~tests~"

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Copy CI env
        run: |
          cp .env.ci .env
          # ensure DB host/port for runner (runner connects to service via localhost)
          php -r "file_put_contents('.env', preg_replace(['/DB_HOST=.*/','/DB_PORT=.*/'], ['DB_HOST=127.0.0.1','DB_PORT=3306'], file_get_contents('.env')));"
          cat .env

      - name: Cache Composer dependencies
        uses: actions/cache@v4
        with:
          path: ~/.composer/cache
          key: ${{ runner.os }}-composer-${{ hashFiles('**/composer.lock') }}
          restore-keys: |
            ${{ runner.os }}-composer-
            ${{ runner.os }}-composer-

      - name: Install Composer dependencies
        run: |
          echo "Installing Composer dependencies..."
          composer install --no-interaction --no-suggest --prefer-dist --optimize-autoloader --no-progress
          echo "âœ… Composer dependencies installed!"

      - name: Wait for MySQL to be ready
        run: |
          echo "Waiting for MySQL to be ready (up to ~120s)..."
          for i in $(seq 1 30); do
            if mysqladmin ping -h 127.0.0.1 -uroot -proot --silent; then
              echo "MySQL is up after $i attempts!"
              mysql -h 127.0.0.1 -uroot -proot -e "SHOW DATABASES;"
              mysql -h 127.0.0.1 -uroot -proot -e "USE kangbeef_test; SHOW TABLES;" || echo "No tables found - expected for fresh database"
              break
            fi
            echo "MySQL not ready yet ($i/30). Sleeping 2s..."
            sleep 2
          done
          
          # Final connection test with proper error handling
          if ! mysql -h 127.0.0.1 -uroot -proot -e "SELECT 1;" 2>/dev/null; then
            echo "ERROR: MySQL connection failed"
            exit 1
          fi
          
          echo "âœ… MySQL connection verified successfully!"

      - name: Generate APP_KEY (persist to .env)
        run: |
          php artisan key:generate --force
          echo "APP_KEY generated and saved in .env"
          grep APP_KEY .env || true

      - name: Setup Database
        run: |
          echo "Setting up database..."
          
          # Verify database connection first
          php artisan tinker --execute="DB::connection()->getPdo(); echo 'Database connection verified';"
          
          # Run migrations with verbose output
          php artisan migrate --force -v
          
          # Verify migrations completed
          echo "âœ… Database migrations completed!"
          
          # Optional: Seed database if needed
          if [ -f "database/seeders/DatabaseSeeder.php" ]; then
            echo "Seeding database..."
            php artisan db:seed --class=DatabaseSeeder --force || echo "No seeders found or seeding failed"
          fi

      - name: Verify Setup
        run: |
          echo "Verifying test setup..."
          
          # Check Laravel environment
          php artisan env --key=APP_ENV
          php artisan env --key=DB_CONNECTION
          php artisan env --key=DB_DATABASE
          
          # Test database connection from Laravel
          php artisan tinker --execute="echo 'Laravel database connection: ' . DB::connection()->getDatabaseName();"
          
          echo "âœ… Setup verification completed!"
          
      - name: Run Tests
        run: |
          echo "ðŸ§ª Running Pest tests..."
          
          # Run tests with better error handling
          ./vendor/bin/pest --colors=always --coverage-clover=coverage.xml --verbose || {
            echo "âŒ Tests failed!"
            echo "ðŸ“Š Uploading coverage for passed tests..."
            exit 1
          }
          
          echo "âœ… All tests completed!"
          
      - name: Code Quality Check
        run: |
          echo "ðŸ” Running code quality checks..."
          
          # Run Pint for code formatting
          if ! vendor/bin/pint --test; then
            echo "âŒ Code formatting issues found!"
            echo "Run 'vendor/bin/pint' to fix formatting issues."
            exit 1
          fi
          
          echo "âœ… Code quality checks passed!"
          
      - name: Security Audit
        run: |
          echo "ðŸ”’ Running security audit..."
          
          # Check for known security vulnerabilities
          if ! composer audit; then
            echo "âš ï¸ Security vulnerabilities found in dependencies!"
            echo "Please review and update vulnerable packages."
          else
            echo "âœ… No security vulnerabilities found!"
          fi
          
      - name: Upload coverage reports to Codecov
        if: always() && github.event_name == 'push'
        uses: codecov/codecov-action@v4
        with:
          file: ./coverage.xml
          flags: unittests
          name: codecov-umbrella
          fail_ci_if_error: false
          
      - name: Upload Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: pest-results-${{ matrix.php-version }}-${{ github.run_number }}
          path: |
            ./coverage.xml
            ./storage/logs/
          retention-days: 30
          
      - name: Test Summary
        if: always()
        run: |
          echo "## ðŸ§ª Test Summary" >> $GITHUB_STEP_SUMMARY
          echo "| PHP Version | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| ${{ matrix.php-version }} | ${{ job.status == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ job.status }}" = "success" ]; then
            echo "âœ… All tests passed successfully!"
          else
            echo "âŒ Some tests failed. Check the logs above for details."
            exit 1
          fi
  deploy:
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/dev'
    environment:
      name: ${{ github.ref == 'refs/heads/main' && 'production' || 'staging' }}
      url: ${{ steps.deploy.outputs.url }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Setup SSH agent
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.DEPLOY_SSH_KEY }}

      - name: Upload repo tarball to runner
        run: |
          git archive -o release.tar HEAD
          mkdir -p release && tar -xf release.tar -C release

      - name: Copy release to remote and run deploy script
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          port: ${{ secrets.SSH_PORT }}
          source: "release/**"
          target: "${{ secrets.REMOTE_TMP_DIR }}/repo_release"

      - name: Execute remote deploy script
        id: deploy
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          port: ${{ secrets.SSH_PORT }}
          script: |
            set -euo pipefail
            # Ensure target dirs exist
            mkdir -p "${{ secrets.REMOTE_RELEASES_DIR }}" "${{ secrets.REMOTE_SHARED_DIR }}"
            # Move uploaded release into releases folder and invoke server script
            TIMESTAMP=$(date +%Y%m%d%H%M%S)
            mv "${{ secrets.REMOTE_TMP_DIR }}/repo_release" "${{ secrets.REMOTE_RELEASES_DIR }}/$TIMESTAMP"
            # Ensure deploy script exists and is executable
            if [ ! -x "${{ secrets.REMOTE_DEPLOY_SCRIPT }}" ]; then
              echo "ERROR: deploy script not found or not executable at ${{ secrets.REMOTE_DEPLOY_SCRIPT }}"
              exit 1
            fi
            # NOTE: we pass branch name using github.ref_name (expanded by Actions runner)
            sudo -E "${{ secrets.REMOTE_DEPLOY_SCRIPT }}" "$TIMESTAMP" "${{ github.ref_name }}"
            
            # Output deployment URL for environment
            if [ "${{ github.ref_name }}" = "main" ]; then
              echo "url=https://kangbeef.com" >> $GITHUB_OUTPUT
            else
              echo "url=https://staging.kangbeef.com" >> $GITHUB_OUTPUT
            fi
